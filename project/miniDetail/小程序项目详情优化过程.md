# 问题
在招商好房2.0ui换新的时候,甲方体验时发现有两个问题:
1. 详情页白屏时间过长,体验人员反馈要等几秒,扫码和点击进入其他的页面时几乎没有白屏
2. 详情中的全屏图展示出现后,滑动不上去,操作不跟手,滑动了之后没能马上上去,打开的页面越多卡的越久(首页>帮我找房>结果列表>详情页)
3. 导致想进详情看楼盘信息,用户等待加载的流程很长,体验很差
4. 上面问题处理完后产品希望减少小程序的启动耗时,加快进入小程序项目详情页的体验

# 问题分析

## 白屏处理
1. 小程序在冷启动时,会先在本身的loading页对主包和当前访问的页面的分包进行加载,加载完成后直接进入页面,打开其他页面时是几乎没有白屏
2. 通过开发工具直接编译详情页打开,在白屏的时候发现生命周期里的log日志和请求有在正常打印和响应
3. 结合有全屏图的时候才会有白屏问题,查看全屏图相关逻辑发现,全屏图在没加载出来之前对详情内容的view做了opacity:0的隐藏
4. 全屏图基于项目详情接口返回,返回后开始加载全屏图,全屏图加载完成后才解除隐藏
5. 跟产品和用户沟通后,觉得这是不合理的,可以接受在详情接口返回后,直接展示详情内容,全屏图加载完成后再展示全屏图,避免白屏

## 全屏图滑动卡顿
1. 全屏图没有遮罩进行阻挡滑动,滑动操作的回调并没有立马执行,而是有一点延迟,打开的页面越多延迟越长
2. 发现可以进行滑动操作时都和底部出现的楼盘顾问信息卡片展示内容的时机一致,合理怀疑是楼盘顾问信息获取和展示的逻辑存在长任务,导致信息展示过慢和出现交互时间过长性能指标问题
3. 获取顾问信息接口响应在70毫秒左右,发现是接口响应完成后就开始卡没法进行其他交互
4. 发现是顾问信息是全局vuex里存放和获取的,而该计算属性字段在全局mixins里,打开的页面和组件越多,越多这个计算属性watcher
5. 页面打开时最少更改两次,一次清空,一次获取,根据一些业务逻辑最多可以更改三次,会多次触发这个计算属性所有的watcher和一些用到该属性的视图更新,这就是导致卡顿的长任务,长任务执行完显示了底部顾问卡片信息,此时之前阻塞的滑动事件也开始处理
6. 把全局mixins里的计算属性去掉,改到只在用到的页面组件里定义,减少无用watcher
7. 优化属性变更逻辑,去除初始化清空方法,后端提供新判断接口直接返回当前展示的顾问,减少vuex里顾问属性的频繁变更,改为只会调用一次

# 性能指标
```js
const performance = wx.getPerformance()
const observer = performance.createObserver((entryList) => {
  console.log('performance', entryList.getEntries())
})
observer.observe({ entryTypes: ['render', 'navigation'] })
```

## 白屏和滑动卡顿优化后(杀死后冷启动直接进详情页面)
appLaunch: 起点为小程序拉起,终点为首个页面 firstRender 结束时间(该页面onReady的时间) 2820  onReady是初次渲染完成;

fcp: 2903 , 减去appLaunch开始时间得到;

lcp: 3065 , 减去appLaunch开始时间得到;

可以看出第一次冷启动时耗时主要在小程序拉起到页面onReady之间的过程,后续的问题就是要降低这块的时间,加快详情页onReady完的时间

## 优化
1. 对详情页面部分从线上展厅包单独分包出来,减少小程序拉起进入时加载的资源,同时增加preload预加载分包,在线上展厅分包时提前加载详情页的分包
2. 使用异步分包组件方式,实现一个plugins自动配置页面使用到的分包组件的占位组件componentHolder,有效降低了主包的大小
3. appLaunch花费1700, fcp 能稳定在2秒附近